---
title: "Data Availability"
author: "COVerAGE-DB"
date: "5/13/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Overview
These two data availability dashboards indicate which populations have data captured (all rows)

  - `sex` indicates whether some data (Cases, Deaths, Tests) were collected by both sex and age. If `false` then it's just both-sex data.
  - `tests` indicates whether age-structured test counts were collected.
  - `passing` indicates whether collected data makes it through the checks and processing. `false` values could be due to temporary data entry errors awaiting fixes.

The columns are sortable, and there is a search box if you're looking for something in particular.

# Data availability {.tabset}

```{r, include = FALSE}
library(tidyverse)
library(lubridate)
library(DT)
library(here)

# the most inclusive dataset:
captured <- 
  readRDS(here::here("Data/inputDBhold.rds")) %>% 
  filter(Age != "TOT",
         Age != "UNK") %>% 
  mutate(date = dmy(Date),
         date = as.character(date),
         Region = case_when(grepl("ITinfo", Code) ~ "All (infogr.)",
                            grepl("ITbol", Code) ~ "All (Boll.)",
                            TRUE ~ Region)) %>% 
  arrange(Country, Region, date) %>% 
  group_by(Country, Region, date) %>% 
    mutate(sex = all(c("m","f") %in% Sex)) %>% 
    slice(1) %>% 
  ungroup() %>% 
  select(Country, Region, date, sex)

# what has made it through to the end:

processed <- 
  readRDS(here::here("Data/Output_10.rds")) %>% 
  mutate(date = dmy(Date),
         date = as.character(date),
         Region = case_when(grepl("ITinfo", Code) ~ "All (infogr.)",
                            grepl("ITbol", Code) ~ "All (Boll.)",
                            TRUE ~ Region)) %>% 
  arrange(Country, Region, date) %>% 
  group_by(Country, Region, date) %>% 
  mutate(sex = all(c("m","f") %in% Sex),
         tests = any(!is.na(Tests)),
         passing = TRUE) %>% 
  slice(1) %>% 
  ungroup() %>% 
  select(Country, Region, date, sex, tests, passing)

available <-
  left_join(captured,
            processed) %>% 
  mutate(passing = ifelse(is.na(passing), FALSE, TRUE),
         tests = ifelse(is.na(tests), FALSE, tests)) %>% 
  select(Country, Region, date, sex, tests, passing) %>% 
  arrange(Country, Region, date)

AvailabilityTableBig<-
available %>% 
  datatable(options = list(pageLength = 100)) %>% 
  formatStyle(
    'sex',
    backgroundColor = styleEqual(c(TRUE, FALSE), c('#bf85de', '#CCCCCC'))
  ) %>% 
  formatStyle(
    'tests',
    backgroundColor = styleEqual(c(TRUE, FALSE), c('#bf85de', '#CCCCCC'))
  ) %>% 
  formatStyle(
    'passing',
    backgroundColor = styleEqual(c(TRUE, FALSE), c('#84e3a5', '#e38227'))
  )

captured2  <-
  captured %>% 
  group_by(Region, Country) %>% 
  summarize(sex = any(sex))
processed2 <-
  processed %>% 
  group_by(Region, Country) %>% 
  summarize(passing = any(passing),
         tests = any(tests)
      )

available2 <-
  left_join(captured2,
            processed2) %>% 
  mutate(passing = ifelse(is.na(passing), FALSE, TRUE),
         tests = ifelse(is.na(tests), FALSE, tests)) %>% 
  select(Country, Region, sex, tests, passing) %>% 
  arrange(Country, Region)

AvailabilityTableSmaller<-
available2 %>% 
  datatable(options = list(pageLength = 100)) %>% 
  formatStyle(
    'sex',
    backgroundColor = styleEqual(c(TRUE, FALSE), c('#bf85de', '#CCCCCC'))
  ) %>% 
  formatStyle(
    'tests',
    backgroundColor = styleEqual(c(TRUE, FALSE), c('#bf85de', '#CCCCCC'))
  ) %>% 
  formatStyle(
    'passing',
    backgroundColor = styleEqual(c(TRUE, FALSE), c('#84e3a5', '#e38227'))
  )

```

## By Country, Region

```{r, echo = FALSE}
AvailabilityTableSmaller
```
```

## By Country, Region, Date

```{r, echo = FALSE}
AvailabilityTableBig
```

## {-}

